<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
        <title>ws-test</title>
	</head>
    
    <script>

        let conn = (id) => {
            fetch('http://localhost:3000/join', {
                method: 'POST',
                headers: {
                    'content-type': 'application/json'
                },
                body: JSON.stringify({
                    name: 'krillex',
                    gameId: id
                })
            })
            .then(async (res) => {
                const data = await res.json();

                console.log(data);

                if (res.status != 200) throw 'nehe';
                return data;
            })
            .then(res => {
                console.log('join ze game');
                
                let socket = new WebSocket('ws://localhost:3000'); 
                socket.onopen = () => {
                    socket.send(JSON.stringify({
                        type: 0,
                        name: 'player2',
                        gameId: id,
                        token: res.token,
                    }));
                };
    
                socket.onmessage = (m) => console.log('MESSAGE', m);
                socket.onclose = () => console.log('CLOSE');
                socket.onerror = () => console.log('ERROR');
            });


        };


        window.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('form');
            const input = document.getElementById('input');
            form.onsubmit = (evt) => {
                
                evt.preventDefault();
                
                conn(input.value);
                
                console.log(input.value);
            }
        });



    </script>

    <body>
        

        <form id="form">
            <input id="input" type="text">
            <input type="submit">
        </form>
    </body>
</html>